<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>üèõÔ∏è Tourism Explorer - Explore tourism and accomodation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --ink:#1a365d; --muted:#4a5568; --soft:#f7fafc; --brand:#0ea5e9; --brand2:#06b6d4; --card:#ffffff; --dubai-blue:#0ea5e9; --dubai-gold:#d4af37; --dubai-teal:#06b6d4; --dubai-navy:#1e3a8a; }
    body{background:linear-gradient(135deg, #f0f9ff, #e0f2fe);color:var(--ink);font-family:'Inter', system-ui, -apple-system, sans-serif;}
    .navbar{background:linear-gradient(135deg,var(--dubai-blue),var(--dubai-teal));box-shadow:0 4px 20px rgba(14,165,233,0.3);}
    .navbar .navbar-brand,.navbar .navbar-text{color:#fff;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.2);}
    .card-soft{border:1px solid #e7eef5;box-shadow:0 4px 14px rgba(16,24,40,.06);background:var(--card);border-radius:18px}
    .mapbox{width:100%;height:440px;border:1px solid #e7eef5;border-radius:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .prewrap{white-space:pre-wrap}
    .badge-soft{background:#eef2ff;color:#3730a3;border-radius:999px}
    .nav-tabs{border-bottom:1px solid #e7eef5}
    .stat{border:1px solid #e7eef5;border-radius:16px;padding:14px 16px;background:#fff}
    .stat .label{color:#677084;font-size:.9rem}
    .stat .value{font-weight:700;font-size:1.15rem}
    .btn-pill{border-radius:999px}
    .form-help{font-size:.85rem;color:#677084}
    .finder-cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media (max-width: 992px){ .finder-cards{grid-template-columns:1fr} }
    .prop-card{border:1px solid #e7eef5;border-radius:16px;background:#fff;padding:14px;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;}
    .prop-card:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(20,30,60,.08)}
    .prop-title{font-weight:800}
    .pill{border-radius:999px;padding:.2rem .55rem;background:#f1f5ff;border:1px solid #e7eef5;font-size:.8rem}
    .rating{display:inline-flex;align-items:center;gap:6px}
    .rating .star{color:#f59e0b}
    .next-steps-notice{
      background:linear-gradient(135deg,#dc2626,#b91c1c);
      color:white;
      padding:16px;
      margin-top:20px;
      border-radius:12px;
      text-align:center;
      font-weight:bold;
      box-shadow:0 4px 12px rgba(220,38,38,0.3);
      border:2px solid #991b1b;
    }
    .next-steps-notice:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(220,38,38,0.4);
    }
    
    /* Priority Dropdown Color Coding */
    .priority-high {
      background-color: #fef2f2 !important;
      color: #dc2626 !important;
      border-color: #fca5a5 !important;
      font-weight: 600;
    }
    .priority-medium {
      background-color: #fffbeb !important;
      color: #d97706 !important;
      border-color: #fcd34d !important;
      font-weight: 600;
    }
    .priority-low {
      background-color: #f0fdf4 !important;
      color: #16a34a !important;
      border-color: #bbf7d0 !important;
      font-weight: 600;
    }
    
    /* Chat Interface Styles */
    .chat-message {
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .chat-message.user {
      flex-direction: row-reverse;
    }
    .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .chat-avatar.user {
      background: #0d6efd;
      color: white;
    }
    .chat-avatar.assistant {
      background: #198754;
      color: white;
    }
    .chat-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .chat-bubble.user {
      background: #0d6efd;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .chat-bubble.assistant {
      background: white;
      color: #333;
      border: 1px solid #dee2e6;
      border-bottom-left-radius: 0.25rem;
    }
    .chat-bubble.assistant.typing {
      background: #f8f9fa;
      font-style: italic;
      color: #6c757d;
    }
    #chatContainer {
      scroll-behavior: smooth;
    }
    #chatContainer::-webkit-scrollbar {
      width: 6px;
    }
    #chatContainer::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    #chatContainer::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Priority Dropdown Styles */
    .priority-select {
      min-width: 140px;
      width: 140px;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
      transition: all 0.2s ease;
      font-weight: 500;
      position: relative;
    }
    
    .priority-select:focus,
    .priority-select:active {
      z-index: 999;
    }
    
    .priority-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .priority-select option {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .priority-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      position: relative;
      z-index: 1;
      margin-left: 10px;
      min-height: 50px;
    }
    
    .priority-label {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 2px;
    }
    
    /* POI Control Row Styles */
    .poi-control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      position: relative;
    }
    
    .poi-control-row:hover {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    
    .poi-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      margin-right: 10px;
    }
    
    .poi-left-section {
      display: flex;
      align-items: center;
      flex: 1;
      min-width: 0;
    }
    
    .poi-switch {
      display: flex;
      align-items: center;
    }
    
    .poi-switch .form-check-input {
      margin-right: 8px;
      transform: scale(1.1);
    }
    
    .poi-switch .form-check-label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin: 0;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container-fluid">
      <span class="navbar-text">üèõÔ∏è Tourism Explorer</span>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <button id="btnOpenAIModal" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#openaiModal" style="background: linear-gradient(135deg, var(--dubai-blue), var(--dubai-teal)); color: white; font-weight: 600; border: none; border-radius: 20px; box-shadow:0 2px 10px rgba(14,165,233,0.4);">‚ú® Ask Travel Guide</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="background: linear-gradient(135deg, rgba(14,165,233,0.1), rgba(6,182,212,0.1)); backdrop-filter: blur(10px); border-radius: 15px 15px 0 0; border: 2px solid var(--dubai-blue);">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-retail" data-bs-toggle="tab" data-bs-target="#panel-retail" type="button" role="tab" style="background: linear-gradient(135deg, var(--dubai-blue), var(--dubai-teal)); color: white; font-weight: 700; border-radius: 15px 15px 0 0; box-shadow:0 2px 8px rgba(14,165,233,0.3);">üèõÔ∏è Tourism Attractions Scanner</button>
      </li>
    </ul>

    <div class="tab-content py-3">

      <!-- ===== Tourism Attractions Scanner ===== -->
      <div class="tab-pane fade show active" id="panel-retail" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <span class="badge badge-soft px-3 py-2">Search location</span>
                <div class="d-flex gap-2">
                  <button id="btnLocate2" class="btn btn-sm btn-pill" style="background: linear-gradient(135deg, var(--dubai-navy), var(--dubai-blue)); color: white; border: none; box-shadow:0 2px 8px rgba(30,58,138,0.3);">üìç Use My Location</button>
                </div>
              </div>
              <div class="position-relative my-2">
                <span class="position-absolute" style="left:10px;top:50%;transform:translateY(-50%);opacity:.6">üîé</span>
                <input id="searchBox2" class="form-control ps-5" placeholder="explore tourism and accomodations" style="border: 2px solid var(--dubai-teal); border-radius: 10px;">
              </div>
              <div id="map2" class="mapbox"></div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Search Radius: <b><span id="retailRadiusLbl">1000</span> m</b></label>
                  <input id="retailRadius" type="range" class="form-range" min="200" max="5000" value="1000" step="50">
                </div>
                <div class="col-6">
                  <label class="form-label">Max Places per Type: <b><span id="retailLimitLbl">40</span></b></label>
                  <input id="retailLimit" type="range" class="form-range" min="10" max="60" value="40" step="5">
                </div>
              </div>

              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Min Rating</label>
                  <select id="minRating" class="form-select">
                    <option value="0" selected>Any</option><option value="3.5">3.5+</option><option value="4.0">4.0+</option><option value="4.5">4.5+</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Open Now</label>
                  <select id="openNow" class="form-select">
                    <option value="any" selected>Any</option><option value="yes">Yes</option>
                  </select>
                </div>
              </div>

              <div class="text-muted small mt-2">Selected: <span id="retailLatLng">‚Äî</span></div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card card-soft p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-1">POI Types &amp; Importance</h6>
              </div>
              <div class="text-muted small mb-1">Toggle types &amp; set importance levels for nearby facilities.</div>

              <div id="poiLegend" class="small mb-2"></div>
              <div id="poiList" class="row g-2 mt-2"></div>

              <div class="mt-3 d-grid gap-2">
                <button id="btnScanPOI" class="btn btn-pill" style="background: linear-gradient(135deg, var(--dubai-blue), var(--dubai-teal)); color: white; border: none; font-weight: 600; box-shadow:0 2px 10px rgba(14,165,233,0.4);">üîç Scan Area (Places)</button>
                <button id="btnScoreRetail" class="btn btn-pill" disabled style="background: linear-gradient(135deg, var(--dubai-gold), #f59e0b); color: white; border: none; font-weight: 600; box-shadow:0 2px 10px rgba(212,175,55,0.4);">‚≠ê Compute Score</button>
                <div id="scoreErr" class="text-danger small mt-2 d-none"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-soft p-3 mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Feasibility Summary</h6>
            <button id="btnResetRetail" class="btn btn-sm btn-outline-secondary btn-pill">Reset</button>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-2"><div class="stat"><div class="label">Raw Score</div><div id="retRaw" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Normalized</div><div id="retNorm" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Types Scanned</div><div id="retTypes" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Radius (m)</div><div id="retRadius" class="value">‚Äî</div></div></div>
            <div class="col-md-4"><div class="stat"><div class="label">Centers &amp; Filters</div><div id="retMeta" class="value small">‚Äî</div></div></div>
          </div>

          <pre id="retailBreakdown" class="form-control mono prewrap mt-2" style="min-height:110px;">‚Äî</pre>
        </div>

        <!-- Flat POI List -->
        <div class="card card-soft p-3 mt-3">
          <div class="d-flex flex-wrap gap-2 align-items-end">
            <div>
              <label class="form-label mb-1">Category (POI Type)</label>
              <select id="poiCategory" class="form-select form-select-sm" style="min-width:260px">
                <option value="" selected disabled>‚Äî select after scanning ‚Äî</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1">Quick Filter (text)</label>
              <input id="poiFilterText" class="form-control form-select-sm" placeholder="name/address contains...">
            </div>
            <div class="ms-auto d-flex gap-2">
              <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm" type="button">Export CSV</button>
              <button id="btnExportXLSX" class="btn btn-outline-secondary btn-sm" type="button">Export XLSX</button>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-hover" id="poiFlatTable">
              <thead class="table-light">
                <tr>
                  <th>#</th><th>Name</th><th>Address</th><th>Rating</th><th>Ratings Count</th><th>Type</th><th>Google Maps</th>
                </tr>
              </thead>
              <tbody id="poiFlatBody"><tr><td colspan="7" class="text-muted">Scan an area, choose a category, and the list will appear here.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OpenAI Modal -->
  <div class="modal fade" id="openaiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">‚ú® Tourism Guide - AI Travel Assistant</h6>
          <div class="d-flex gap-2">
            <button id="btnResetChat" class="btn btn-outline-secondary btn-sm" type="button">üîÑ Reset</button>
            <button id="btnStopChat" class="btn btn-outline-danger btn-sm d-none" type="button">‚èπ Stop</button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body p-0">
          <!-- Chat Messages Container -->
          <div id="chatContainer" class="p-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
            <div class="text-center text-muted py-4">
              <div class="mb-3">üåç‚ú®</div>
              <div>Welcome to Tourism Guide! I'm your AI travel assistant.</div>
              <div class="small mt-2">Discover amazing destinations, attractions, and travel experiences worldwide.</div>
            </div>
          </div>
          
          <!-- Chat Input Area -->
          <div class="border-top p-3">
            <div class="mb-3">
              <label class="form-label small">Quick Context</label>
              <div class="d-flex gap-2">
                <button id="btnCtxRetail" class="btn flex-fill" type="button" style="background: linear-gradient(135deg, var(--dubai-blue), var(--dubai-teal)); color: white; border: none; font-weight: 600;">üèõÔ∏è Tourism Attractions</button>
              </div>
            </div>
            
            <div class="input-group">
              <textarea id="openaiPrompt" class="form-control" rows="2" placeholder="Ask about destinations, attractions, travel tips, culture..." style="resize: none; border: 2px solid var(--dubai-teal);"></textarea>
              <button id="btnRunOpenAI" class="btn btn-primary" type="button">
                <span class="send-text">Send</span>
                <span class="loading-text d-none">
                  <span class="spinner-border spinner-border-sm me-1"></span>
                  Thinking...
                </span>
              </button>
            </div>
            <div class="form-text small mt-1">üí° Tip: Use context buttons to add current analysis data to your message</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =======================================================
    // Encrypted keys (no UI)
    const GMAPS_KEY_ENCRYPTED = "Qs5skmSuUzGSs5TwYxnoazaHLEgJ995LrvyyWiziwWdIzkyAfrYq";
    const OPENAI_KEY_ENCRYPTED = "cOw7g0W4eGXznpOpZzSoOFmOIm04p+lSkou0OhHs9D1LxWarB5lzePb5ss9QHLpgM5w9TQu9xmagjqUtGv/+BG3lXsJgk1oA8orawWIylTpUvw81L6jveoKPlCtUy8AmbekhmX3uIhrCkZrZExCBemLlCXNY87VUh5e/NBfo0DtM/nzHYbxQfOD5h8dKL5ZPVr03dgup2HPxj5IBC/f1BjLgIrI=";

    let GMAPS_KEY="", OPENAI_KEY="";
    let pyodide=null, pyReady=false, mapsLoaded=false;

    // ---------- Pyodide init & decrypt ----------
    (async () => {
      try{
        pyodide = await loadPyodide();
        await pyodide.runPythonAsync(`
import base64, hashlib
def decrypt_key(encrypted_data, passphrase="default_salt_2024"):
    try:
        encrypted_bytes = base64.b64decode(encrypted_data)
        key_hash = hashlib.sha256(passphrase.encode()).digest()
        out = bytearray()
        for i, b in enumerate(encrypted_bytes):
            out.append(b ^ key_hash[i % len(key_hash)])
        return out.decode('utf-8')
    except Exception:
        return ""
        `);
        pyReady = true;
        await decryptKeysAndLoad();
      }catch(e){
        console.error("Pyodide init failed", e);
        fallbackNoKeys();
      }
    })();

    async function decryptKeysAndLoad(){
      try{
        if(pyReady && pyodide){
          if (GMAPS_KEY_ENCRYPTED && !GMAPS_KEY){
            pyodide.globals.set('enc_gmaps', GMAPS_KEY_ENCRYPTED);
            GMAPS_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_gmaps)`);
          }
          if (OPENAI_KEY_ENCRYPTED && !OPENAI_KEY){
            pyodide.globals.set('enc_openai', OPENAI_KEY_ENCRYPTED);
            OPENAI_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_openai)`);
          }
        }
      }catch(e){ console.warn("Decryption error", e); }
      loadMapsIfKey();
    }
    function loadMapsIfKey(){
      if(mapsLoaded || !GMAPS_KEY) return;
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&libraries=places`;
      s.async=true; s.defer=true;
      s.onload=()=>{ mapsLoaded=true; safeInitMaps(); };
      s.onerror=()=>{ console.error('Failed to load Google Maps.'); };
      document.head.appendChild(s);
    }
    function fallbackNoKeys(){ setTimeout(decryptKeysAndLoad, 1200); }

    // =======================================================

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ======================= MAPS: TOURISM SCANNER =======================
    let map2=null, marker2=null, circle2=null;
    let placesService2=null;
    let autocomplete2=null;
    let lastRetailScan=null, lastRetailResults=null;

    // Tourism POI types organized by categories
    const POI_CATEGORIES = {
      'Tourist Attractions': [
        {type:'tourist_attraction',label:'Tourist Attractions',priority:'high',color:'#d4af37',emoji:'üèõÔ∏è'},
        {type:'museum',label:'Museums',priority:'high',color:'#8b4513',emoji:'üèõÔ∏è'},
        {type:'art_gallery',label:'Art Galleries',priority:'high',color:'#9333ea',emoji:'üé®'},
        {type:'zoo',label:'Zoos & Wildlife',priority:'medium',color:'#10b981',emoji:'ü¶Å'},
        {type:'aquarium',label:'Aquariums',priority:'medium',color:'#0284c7',emoji:'üê†'},
        {type:'amusement_park',label:'Theme Parks',priority:'high',color:'#f97316',emoji:'üé¢'},
        {type:'park',label:'Parks & Gardens',priority:'medium',color:'#16a34a',emoji:'üå≥'},
        {type:'beach',label:'Beaches',priority:'high',color:'#0891b2',emoji:'üèñÔ∏è'}
      ],
      'Dining & Food': [
        {type:'restaurant',label:'Restaurants',priority:'high',color:'#16a34a',emoji:'üçΩÔ∏è'},
        {type:'cafe',label:'Caf√©s & Tea Houses',priority:'medium',color:'#dc2626',emoji:'‚òï'}
      ],
      'Entertainment & Nightlife': [
        {type:'movie_theater',label:'Cinemas',priority:'medium',color:'#7c2d12',emoji:'üé¨'},
        {type:'night_club',label:'Nightlife',priority:'medium',color:'#7c3aed',emoji:'üåô'},
        {type:'bar',label:'Bars & Pubs',priority:'medium',color:'#b91c1c',emoji:'üç∫'},
        {type:'casino',label:'Casinos',priority:'low',color:'#dc2626',emoji:'üé∞'}
      ],
      'Shopping & Wellness': [
        {type:'shopping_mall',label:'Shopping Centers',priority:'medium',color:'#ea580c',emoji:'üõçÔ∏è'},
        {type:'jewelry_store',label:'Jewelry Shops',priority:'low',color:'#fbbf24',emoji:'üíé'},
        {type:'clothing_store',label:'Fashion Stores',priority:'medium',color:'#ec4899',emoji:'üëó'},
        {type:'spa',label:'Spas & Wellness',priority:'medium',color:'#0ea5e9',emoji:'üíÜ'}
      ],
      'Accommodation & Services': [
        {type:'lodging',label:'Hotels & Service Apartments',priority:'high',color:'#1e40af',emoji:'üè®'},
        {type:'hospital',label:'Medical Centers',priority:'high',color:'#ef4444',emoji:'üè•'},
        {type:'pharmacy',label:'Pharmacies',priority:'medium',color:'#16a34a',emoji:'üíä'},
        {type:'transit_station',label:'Transport Hubs',priority:'high',color:'#f59e0b',emoji:'üöå'},
        {type:'subway_station',label:'Metro Stations',priority:'high',color:'#14b8a6',emoji:'üöá'},
        {type:'airport',label:'Airports',priority:'high',color:'#64748b',emoji:'‚úàÔ∏è'},
        {type:'car_rental',label:'Car Rentals',priority:'medium',color:'#0f172a',emoji:'üöó'},
        {type:'bank',label:'Banks & ATMs',priority:'low',color:'#64748b',emoji:'üè¶'},
        {type:'atm',label:'ATMs',priority:'medium',color:'#6b7280',emoji:'üí≥'}
      ]
    };
    
    // Flatten for backward compatibility
    const DEFAULT_POI_TYPES = Object.values(POI_CATEGORIES).flat();

    // Priority to weight mapping
    function getPriorityWeight(priority) {
      const weights = { 'high': 1.5, 'medium': 1.0, 'low': 0.5 };
      return weights[priority] || 1.0;
    }
    
    // Update POI priority and apply color coding
    function updatePOIPriority(poiType, newPriority) {
      // Find and update the POI type in our global array
      const poiIndex = DEFAULT_POI_TYPES.findIndex(poi => poi.type === poiType);
      if (poiIndex !== -1) {
        DEFAULT_POI_TYPES[poiIndex].priority = newPriority;
      }
      
      // Update color coding for this dropdown
      const dropdown = document.getElementById(`poi_priority_${poiType}`);
      if (dropdown) {
        dropdown.className = dropdown.className.replace(/priority-(high|medium|low)/g, '');
        dropdown.classList.add(`priority-${newPriority}`);
        
        // Store hidden weight for backend calculations (not shown to user)
        const weights = { 'high': 1.0, 'medium': 0.5, 'low': 0.2 };
        dropdown.dataset.weight = weights[newPriority];
      }
      
      // Recalculate scores if we have data
      if (lastRetailScan) {
        computeRetailScore();
      }
    }
    
    function safeInitMaps(){ try{ initMap2(); }catch(e){ console.warn("Map2 init error", e); } }

    // Map 2 (Tourism Scanner)
    const markersByType={};
    function initMap2(){
      if(!document.getElementById('map2')) return;
      map2=new google.maps.Map(document.getElementById('map2'),{center:{lat:22.5726,lng:88.3639},zoom:12,mapTypeControl:false});
      placesService2=new google.maps.places.PlacesService(map2);
      const input=document.getElementById('searchBox2');
      autocomplete2=new google.maps.places.Autocomplete(input,{fields:["geometry","name"]});
      autocomplete2.addListener('place_changed',()=>{
        const p=autocomplete2.getPlace(); if(!p.geometry||!p.geometry.location) return;
        const latlng={lat:p.geometry.location.lat(),lng:p.geometry.location.lng()};
        map2.setCenter(latlng); map2.setZoom(15); setMarker2(latlng);
      });
      map2.addListener('click',e=>setMarker2({lat:e.latLng.lat(),lng:e.latLng.lng()}));
      document.getElementById('retailRadius').addEventListener('input',e=>{document.getElementById('retailRadiusLbl').textContent=e.target.value; if(marker2) drawCircle2();});
      document.getElementById('retailLimit').addEventListener('input',e=>document.getElementById('retailLimitLbl').textContent=e.target.value);
      buildPOIControls();
      document.getElementById('btnLocate2').addEventListener('click',()=>{
        if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{
          const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
          map2.setCenter(latlng); map2.setZoom(15); setMarker2(latlng);
        },()=>alert('Location unavailable'));
      });
    }
    function setMarker2(latlng){
      if(marker2) marker2.setMap(null);
      marker2=new google.maps.Marker({position:latlng,map:map2});
      drawCircle2(); document.getElementById('retailLatLng').textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
    function drawCircle2(){
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const latlng=marker2.getPosition(); if(circle2) circle2.setMap(null);
      circle2=new google.maps.Circle({map:map2,center:latlng,radius:radius,fillOpacity:.05,strokeColor:'#2563eb'});
    }
    function clearMarkers(){ Object.values(markersByType).forEach(arr=>arr.forEach(m=>m.setMap(null))); Object.keys(markersByType).forEach(k=>markersByType[k]=[]); }
    function buildPOIControls(){
      const list=document.getElementById('poiList'); list.innerHTML='';
      const legend=document.getElementById('poiLegend'); legend.innerHTML='<span class="me-2">Legend:</span>';
      
      Object.entries(POI_CATEGORIES).forEach(([categoryName, poiTypes]) => {
        // Add category header
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'col-12 mt-3 mb-2';
        categoryHeader.innerHTML = `<h6 class="mb-2" style="color: var(--dubai-blue); font-weight: 600; border-bottom: 2px solid var(--dubai-teal); padding-bottom: 4px;">üìç ${categoryName}</h6>`;
        list.appendChild(categoryHeader);
        
        // Add POI types in this category
        poiTypes.forEach(t=>{
          const div=document.createElement('div'); div.className='col-12';
          div.innerHTML=`
            <div class="poi-control-row">
              <div class="poi-left-section">
                <span class="poi-legend-dot" style="background:${t.color}"></span>
                <div class="poi-switch">
                  <input class="form-check-input" type="checkbox" id="poi_ck_${t.type}" checked>
                  <label class="form-check-label" for="poi_ck_${t.type}">${t.emoji} ${t.label}</label>
                </div>
              </div>
              <div class="priority-section">
                <div class="priority-label">Importance:</div>
                <select id="poi_priority_${t.type}" class="priority-select priority-${t.priority}" onchange="updatePOIPriority('${t.type}', this.value)">
                  <option value="high" ${t.priority === 'high' ? 'selected' : ''}>üî¥ High</option>
                  <option value="medium" ${t.priority === 'medium' ? 'selected' : ''}>üü° Medium</option>
                  <option value="low" ${t.priority === 'low' ? 'selected' : ''}>üü¢ Low</option>
                </select>
              </div>
            </div>`;
          list.appendChild(div);
          
          // Add to legend
          const lg=document.createElement('span'); 
          lg.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; font-size: 13px; font-weight: 500;';
          lg.innerHTML=`<span class="poi-legend-dot" style="background:${t.color}"></span>${t.emoji} ${t.label}`;
          legend.appendChild(lg);
        });
      });
    }

    function makeEmojiMarkerOptions(t, position){
      return { position, map:map2,
        icon:{ path:google.maps.SymbolPath.CIRCLE, scale:7, fillColor:t.color, fillOpacity:1, strokeColor:'#333', strokeWeight:0.5 },
        label:{ text:t.emoji, fontSize:'12px' }, title:t.label };
    }
    async function nearbySearchAllTypes(center, radius, limit){
      const openNowSel=document.getElementById('openNow').value;
      const openNow=openNowSel==='yes'?true:undefined;
      const selected=DEFAULT_POI_TYPES.filter(t=>document.getElementById('poi_ck_'+t.type).checked);
      const resultsByType={}; clearMarkers();
      for(const t of selected){
        resultsByType[t.type]=await new Promise(resolve=>{
          let out=[]; const req={location:center, radius:radius, type:t.type, openNow};
          placesService2.nearbySearch(req,(res,status,pag)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res){
              out=out.concat(res);
              if(pag && pag.hasNextPage && out.length<limit){ setTimeout(()=>pag.nextPage(),250); }
              else resolve(out.slice(0,limit));
            } else resolve(out);
          });
        });
        markersByType[t.type]=[];
        (resultsByType[t.type]||[]).forEach(p=>{
          if(!p.geometry||!p.geometry.location) return;
          const meta = DEFAULT_POI_TYPES.find(x=>x.type===t.type) || {color:'#2563eb',emoji:'‚Ä¢',label:t.label};
          const m=new google.maps.Marker(makeEmojiMarkerOptions(meta,p.geometry.location));
          markersByType[t.type].push(m);
        });
      }
      return resultsByType;
    }

    document.getElementById('btnScanPOI').addEventListener('click', async ()=>{
      if(!marker2){ alert('Pick a center on the map (or paste a project name).'); return; }
      const center=marker2.getPosition();
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const limit=parseInt(document.getElementById('retailLimit').value||'40');
      const minRating=parseFloat(document.getElementById('minRating').value||'0');
      const centerLatLng={lat:center.lat(), lng:center.lng()};
      const results=await nearbySearchAllTypes(centerLatLng, radius, limit);
      lastRetailResults = results;
      const filtered = {}; Object.keys(results).forEach(t=>{ filtered[t]=(results[t]||[]).filter(x=>(x.rating||0)>=minRating); });
      const counts={}, ratings={};
      Object.keys(filtered).forEach(t=>{
        const arr=filtered[t]||[]; counts[t]=arr.length;
        ratings[t]=arr.length ? (arr.reduce((s,x)=>s+(x.rating||0),0)/arr.length) : 0;
      });
      lastRetailScan={center:centerLatLng, radius, counts, ratings, minRating, openNow:document.getElementById('openNow').value};
      document.getElementById('retTypes').textContent=Object.keys(results).length.toString();
      document.getElementById('retRadius').textContent=radius.toString();
      document.getElementById('retMeta').textContent=`Rating>=${minRating||'any'}; Open:${lastRetailScan.openNow}`;
      document.getElementById('retailBreakdown').textContent=
        `Scanned ${Object.keys(results).length} types within ${radius}m.\nCounts: ${JSON.stringify(counts)}\nAvg ratings: ${JSON.stringify(ratings)}\nClick "Compute Score".`;
      document.getElementById('scoreErr').classList.add('d-none');
      document.getElementById('btnScoreRetail').disabled = false;
      const sel = document.getElementById('poiCategory');
      sel.innerHTML = `<option value="" selected disabled>‚Äî choose a category ‚Äî</option>`;
      
      // Group options by category
      Object.entries(POI_CATEGORIES).forEach(([categoryName, poiTypes]) => {
        const categoryPOIs = poiTypes.filter(poi => lastRetailResults && lastRetailResults[poi.type]);
        if (categoryPOIs.length > 0) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = `üìç ${categoryName}`;
          categoryPOIs.forEach(poi => {
            const count = counts[poi.type] || 0;
            const option = document.createElement('option');
            option.value = poi.type;
            option.textContent = `${poi.emoji} ${poi.label} (${count})`;
            optgroup.appendChild(option);
          });
          sel.appendChild(optgroup);
        }
      });
      renderPOIFlatList();
    });

    document.getElementById('btnScoreRetail').addEventListener('click', async ()=>{
      try{
        if(!pyReady){ alert('Python engine is still loading. Please try again.'); return; }
        if(!lastRetailScan){ alert('Run "Scan Area" first.'); return; }
        const weights = {};
        DEFAULT_POI_TYPES.forEach(t => {
          const ckEl = document.getElementById('poi_ck_' + t.type);
          const priority = DEFAULT_POI_TYPES.find(poi => poi.type === t.type)?.priority || 'medium';
          const priorityWeight = getPriorityWeight(priority);
          weights[t.type] = (ckEl && ckEl.checked) ? priorityWeight : 0;
        });
        const cts = {}, rts = {};
        Object.keys(weights).forEach(k=>{
          const c = parseFloat((lastRetailScan.counts && lastRetailScan.counts[k]) || 0);
          const r = parseFloat((lastRetailScan.ratings && lastRetailScan.ratings[k]) || 0);
          cts[k] = isFinite(c) ? c : 0;
          rts[k] = isFinite(r) ? r : 0;
        });
        const payload = { counts: cts, ratings: rts, weights, radius_m: Number(lastRetailScan.radius) || 1 };
        pyodide.globals.set('score_payload', JSON.stringify(payload));
        const result = await pyodide.runPythonAsync(`
import json, math
def score_retail(counts_by_type, avg_rating_by_type, weights, radius_m):
    keys=set(list((counts_by_type or {}).keys())+list((weights or {}).keys())+list((avg_rating_by_type or {}).keys()))
    score=0.0; detail={}
    for t in keys:
        c=float(counts_by_type.get(t,0) or 0); w=float(weights.get(t,0) or 0); r=float(avg_rating_by_type.get(t,0) or 0)
        rb=max(0.0,(r-3.0)*0.5); part=w*(c+rb); detail[t]={"count":c,"weight":w,"avg_rating":r,"component":part}; score+=part
    norm=score/max(1.0, math.log(max(10.0, float(radius_m or 1))))
    return {"raw_score":score,"normalized_score":norm,"detail":detail}

p = json.loads(score_payload)
result = score_retail(p["counts"], p["ratings"], p["weights"], p["radius_m"])
json.dumps(result)
        `);
        const obj = JSON.parse(result);
        document.getElementById('retRaw').textContent = (+obj.raw_score).toFixed(2);
        document.getElementById('retNorm').textContent = (+obj.normalized_score).toFixed(3);

        // Calculate score breakdown by categories
        let scoreBreakdown = '';
        let totalScore = 0;
        const priorityTotals = { high: 0, medium: 0, low: 0 };
        
        // Group amenities by categories
        Object.entries(POI_CATEGORIES).forEach(([categoryName, poiTypes]) => {
          let categoryHasAmenities = false;
          let categoryBreakdown = `\nüìç ${categoryName.toUpperCase()}:\n`;
          
          poiTypes.forEach(t => {
            const ckEl = document.getElementById('poi_ck_' + t.type);
            if (ckEl && ckEl.checked && lastRetailScan.counts && lastRetailScan.counts[t.type]) {
              const count = lastRetailScan.counts[t.type] || 0;
              const priority = t.priority;
              const weight = getPriorityWeight(priority);
              const contribution = count * weight;
              totalScore += contribution;
              priorityTotals[priority] += contribution;
              
              const priorityIcon = priority === 'high' ? 'üî¥' : priority === 'medium' ? 'üü°' : 'üü¢';
              const priorityText = priority === 'high' ? 'High' : priority === 'medium' ? 'Medium' : 'Low';
              categoryBreakdown += `  ${t.emoji} ${t.label}: ${count > 0 ? `${count} available` : 'Limited'} (${priorityIcon} ${priorityText})\n`;
              categoryHasAmenities = true;
            }
          });
          
          if (categoryHasAmenities) {
            scoreBreakdown += categoryBreakdown;
          }
        });
        
        const lines = [];
        lines.push(`üìç Center: ${lastRetailScan.center.lat.toFixed(6)}, ${lastRetailScan.center.lng.toFixed(6)}`);
        lines.push(`üìè Radius: ${lastRetailScan.radius} m`);
        lines.push(`üîç Filters: rating>=${lastRetailScan.minRating||'any'}; open=${lastRetailScan.openNow}`);
        lines.push(``);
        const ratingText = totalScore >= 15 ? 'Excellent' : totalScore >= 10 ? 'Very Good' : totalScore >= 5 ? 'Good' : 'Average';
        lines.push(`üè¢ LOCATION CONVENIENCE SUMMARY:`);
        lines.push(``);
        lines.push(`üî¥ High Importance Facilities: ${Math.round(priorityTotals.high)} options nearby`);
        lines.push(`üü° Medium Importance Facilities: ${Math.round(priorityTotals.medium)} options nearby`);
        lines.push(`üü¢ Low Importance Facilities: ${Math.round(priorityTotals.low)} options nearby`);
        lines.push(``);
        lines.push(`üè¢ AVAILABLE NEARBY AMENITIES:`);
        lines.push(scoreBreakdown);
        document.getElementById('retailBreakdown').textContent = lines.join('\n');
        document.getElementById('scoreErr').classList.add('d-none');
      }catch(err){
        console.error('Compute Score error:', err);
        const box = document.getElementById('scoreErr');
        if(box){ box.textContent = (err && err.message) ? err.message : 'Scoring failed.'; box.classList.remove('d-none'); }
        else { alert('Scoring failed. See console for details.'); }
      }
    });

    // Reset Button
    document.getElementById('btnResetRetail').addEventListener('click', ()=>{
      // Clear map marker and POI markers
      if(marker2) { marker2.setMap(null); marker2 = null; }
      if(circle2) { circle2.setMap(null); circle2 = null; }
      clearMarkers(); // Clear all POI markers
      
      // Reset map to default center and zoom
      if(map2) {
        map2.setCenter({lat:22.5726,lng:88.3639});
        map2.setZoom(12);
      }
      
      // Clear search box
      const searchBox2 = document.getElementById('searchBox2');
      if(searchBox2) searchBox2.value = '';
      
      // Reset form controls to defaults
      document.getElementById('retailRadius').value = 1000;
      document.getElementById('retailRadiusLbl').textContent = '1000';
      document.getElementById('retailLimit').value = 40;
      document.getElementById('retailLimitLbl').textContent = '40';
      document.getElementById('minRating').value = 0;
      document.getElementById('openNow').value = 'any';
      
      // Reset POI category and filter
      document.getElementById('poiCategory').value = '';
      document.getElementById('poiFilterText').value = '';
      
      // Clear results
      ['retRaw', 'retNorm', 'retTypes', 'retRadius', 'retMeta'].forEach(id => 
        document.getElementById(id).textContent = '‚Äî'
      );
      
      // Clear breakdown text
      document.getElementById('retailBreakdown').textContent = '‚Äî';
      
      // Clear location display
      document.getElementById('retailLatLng').textContent = '‚Äî';
      
      // Disable compute score button
      document.getElementById('btnScoreRetail').disabled = true;
      
      // Clear stored scan data
      lastRetailScan = null;
      lastRetailResults = null;
      
      // Reset POI controls to defaults (rebuild them)
      buildPOIControls();
      
      // Clear flat POI list
      renderPOIFlatList();
    });

    const poiSel = document.getElementById('poiCategory');
    const poiFilter = document.getElementById('poiFilterText');
    ['change','input'].forEach(ev=>{
      document.getElementById('minRating').addEventListener(ev, renderPOIFlatList);
      document.getElementById('openNow').addEventListener(ev, renderPOIFlatList);
    });
    if(poiSel) poiSel.addEventListener('change', ()=> renderPOIFlatList());
    if(poiFilter) poiFilter.addEventListener('input', ()=> renderPOIFlatList());

    function normalizeResultItem(type, p, idx){
      let lat=null, lng=null;
      if (p && p.geometry && p.geometry.location) {
        const loc = p.geometry.location;
        lat = (typeof loc.lat === 'function') ? loc.lat() : loc.lat;
        lng = (typeof loc.lng === 'function') ? loc.lng() : loc.lng;
      }
      let queryLink = '';
      if (typeof lat === 'number' && typeof lng === 'number') {
        const latStr = lat.toFixed(7);
        const lngStr = lng.toFixed(7);
        queryLink = `https://www.google.com/maps/dir/?api=1&destination=${latStr},${lngStr}`;
      }
      return {
        idx: idx+1,
        name: p.name || '',
        address: p.vicinity || p.formatted_address || '',
        rating: typeof p.rating==='number' ? p.rating : '',
        ratingCount: p.user_ratings_total || '',
        isOpen: !!(p.opening_hours && p.opening_hours.open_now),
        type,
        link: queryLink
      };
    }
    function currentPOISelection(){
      if(!lastRetailResults) return [];
      const cat = poiSel.value;
      const arr = (cat && lastRetailResults[cat]) ? lastRetailResults[cat] : [];
      const minR = parseFloat(document.getElementById('minRating').value || '0');
      const openSel = document.getElementById('openNow').value;
      const ftxt = (poiFilter.value||'').toLowerCase();
      const rows = arr.map((p,i)=>normalizeResultItem(cat,p,i)).filter(r=>{
        const passRating = (r.rating === '' ? (minR <= 0) : Number(r.rating) >= minR);
        const passOpen = (openSel === 'any') ? true : r.isOpen === true;
        const hay = `${r.name} ${r.address}`.toLowerCase();
        const passQuick = ftxt ? hay.includes(ftxt) : true;
        return passRating && passOpen && passQuick;
      });
      return rows;
    }
    function renderPOIFlatList(){
      const body = document.getElementById('poiFlatBody');
      const rows = currentPOISelection();
      if(!rows.length){
        body.innerHTML = `<tr><td colspan="7" class="text-muted">No items ‚Äî select a category after scanning, or adjust your filters.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map(r=>{
        const poiType = DEFAULT_POI_TYPES.find(p => p.type === r.type);
        const priority = poiType?.priority || 'medium';
        return `<tr>
          <td>${r.idx}</td><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.address)}</td>
          <td>${r.rating!==''?Number(r.rating).toFixed(1):''}</td><td>${r.ratingCount}</td>
          <td>${r.type}</td>
          <td>${r.link ? `<a href="${r.link}" target="_blank" rel="noopener">Open</a>` : ''}</td>
        </tr>`;
      }).join('');
    }

    // Export functionality for POI list
    function csvCell(val){ const s = (val != null ? val : '').toString().replace(/"/g,'""'); return `"${s}"`; }
    function downloadBlob(filename, blob){
      const a = document.createElement('a'); const url = URL.createObjectURL(blob);
      a.href = url; a.download = filename; a.style.display = 'none'; document.body.appendChild(a);
      a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    }

    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) {
        alert('No POI data to export. Please scan an area first and select a category.');
        return;
      }
      const header = ["#","Name","Address","Rating","Ratings Count","Category","Type","Google Maps"];
      const csvRows = rows.map(r=>{
        const poiMeta = DEFAULT_POI_TYPES.find(p => p.type === r.type);
        const category = Object.entries(POI_CATEGORIES).find(([cat, types]) => 
          types.some(t => t.type === r.type)
        )?.[0] || 'Other';
        return [
          r.idx, r.name, r.address, 
          r.rating !== '' ? Number(r.rating).toFixed(1) : '',
          r.ratingCount || '',
          category,
          poiMeta ? `${poiMeta.emoji} ${poiMeta.label}` : r.type || '',
          r.link || ''
        ];
      });
      const csv = [header.join(",")].concat(csvRows.map(r=>r.map(csvCell).join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(`tourism_export_${Date.now()}.csv`, blob);
    });

    document.getElementById('btnExportXLSX').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) {
        alert('No POI data to export. Please scan an area first and select a category.');
        return;
      }
      const data = [["#","Name","Address","Rating","Ratings Count","Category","Type","Google Maps"]]
        .concat(rows.map(r=>{
          const poiMeta = DEFAULT_POI_TYPES.find(p => p.type === r.type);
          const category = Object.entries(POI_CATEGORIES).find(([cat, types]) => 
            types.some(t => t.type === r.type)
          )?.[0] || 'Other';
          return [
            r.idx, r.name, r.address,
            r.rating !== '' ? Number(r.rating).toFixed(1) : '',
            r.ratingCount || '',
            category,
            poiMeta ? `${poiMeta.emoji} ${poiMeta.label}` : r.type || '',
            r.link || ''
          ];
        }));
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "POI_Data");
      const ab = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([ab], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`tourism_export_${Date.now()}.xlsx`, blob);
    });

    // ---------- OpenAI Chat System ----------
    let chatMessages = [];
    let currentAbortController = null;

    function addChatMessage(role, content, isTyping = false) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      
      const avatar = document.createElement('div');
      avatar.className = `chat-avatar ${role}`;
      avatar.textContent = role === 'user' ? 'üë§' : 'üèõÔ∏è';
      
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${role}${isTyping ? ' typing' : ''}`;
      bubble.textContent = content;
      
      if (role === 'user') {
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
      } else {
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
      }
      
      // Remove welcome message if it exists
      const welcomeMsg = chatContainer.querySelector('.text-center');
      if (welcomeMsg) welcomeMsg.remove();
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      return { messageDiv, bubble };
    }

    function updateChatMessage(bubble, content, isTyping = false) {
      bubble.textContent = content;
      bubble.className = bubble.className.replace(' typing', '');
      if (isTyping) bubble.classList.add('typing');
    }

    function resetChat() {
      chatMessages = [];
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = `
        <div class="text-center text-muted py-4">
          <div class="mb-3">üåç‚ú®</div>
          <div>Welcome to Tourism Guide! I'm your AI travel assistant.</div>
          <div class="small mt-2">Discover amazing destinations, attractions, and travel experiences worldwide.</div>
        </div>`;
    }

    document.getElementById('btnResetChat').addEventListener('click', resetChat);

    document.getElementById('btnStopChat').addEventListener('click', () => {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
        
        const btnRun = document.getElementById('btnRunOpenAI');
        const sendText = btnRun.querySelector('.send-text');
        const loadingText = btnRun.querySelector('.loading-text');
        
        btnRun.disabled = false;
        sendText.classList.remove('d-none');
        loadingText.classList.add('d-none');
        
        document.getElementById('btnStopChat').classList.add('d-none');
      }
    });

    // Context button
    document.getElementById('btnCtxRetail').addEventListener('click', () => {
      const textarea = document.getElementById('openaiPrompt');
      let context = '';
      
      if (lastRetailScan && lastRetailResults) {
        const location = `${lastRetailScan.center.lat.toFixed(4)}, ${lastRetailScan.center.lng.toFixed(4)}`;
        const totalPOIs = Object.values(lastRetailScan.counts).reduce((sum, count) => sum + count, 0);
        
        context = `\n\n[Current Analysis Context]\nüìç Location: ${location}\nüîç Scanned ${totalPOIs} tourist attractions within ${lastRetailScan.radius}m radius\nüèõÔ∏è Found facilities: ${Object.entries(lastRetailScan.counts).filter(([k,v]) => v > 0).map(([k,v]) => `${k} (${v})`).join(', ')}\n`;
      } else {
        context = '\n\n[Context: Tourism attraction scanner ready - search a location first to get specific recommendations]';
      }
      
      textarea.value = textarea.value.trim() + context;
      textarea.focus();
    });

    document.getElementById('btnRunOpenAI').addEventListener('click', async () => {
      const promptTextarea = document.getElementById('openaiPrompt');
      const userPrompt = promptTextarea.value.trim();
      
      if (!userPrompt) {
        alert('Please enter a message first.');
        return;
      }
      
      if (!OPENAI_KEY) {
        alert('OpenAI API key not configured. Please check console for setup instructions.');
        console.error('OpenAI API key missing. Set OPENAI_KEY_ENCRYPTED in the source code.');
        return;
      }

      // Add user message
      chatMessages.push({ role: 'user', content: userPrompt });
      addChatMessage('user', userPrompt);
      
      // Clear input
      promptTextarea.value = '';
      
      // Show loading state
      const btnRun = document.getElementById('btnRunOpenAI');
      const sendText = btnRun.querySelector('.send-text');
      const loadingText = btnRun.querySelector('.loading-text');
      
      btnRun.disabled = true;
      sendText.classList.add('d-none');
      loadingText.classList.remove('d-none');
      
      document.getElementById('btnStopChat').classList.remove('d-none');
      
      // Add typing indicator
      const { messageDiv, bubble } = addChatMessage('assistant', 'Thinking about your travel question...', true);
      
      try {
        // Create abort controller
        currentAbortController = new AbortController();
        
        // Prepare messages with system context
        const systemMessage = {
          role: 'system',
          content: `You are a knowledgeable travel guide assistant. Help users discover amazing destinations, tourist attractions, cultural experiences, and travel tips worldwide. 

Key guidelines:
- Provide specific, actionable travel recommendations
- Include practical information like best times to visit, cultural considerations, and local tips  
- Be enthusiastic but informative about destinations
- Suggest both popular attractions and hidden gems when possible
- Consider different travel styles (budget, luxury, adventure, cultural, family, etc.)
- Always prioritize safety and respect for local customs

If the user shares location analysis data, use it to provide contextual recommendations for that specific area.`
        };
        
        const messages = [systemMessage, ...chatMessages];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-4.1',
            messages: messages,
            temperature: 0.7,
            max_tokens: 300,
            stream: true
          }),
          signal: currentAbortController.signal
        });
        
        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';

        try {
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') continue;

                try {
                  const parsed = JSON.parse(data);
                  const content = parsed.choices?.[0]?.delta?.content;
                  if (content) {
                    fullResponse += content;
                    bubble.className = bubble.className.replace(' typing', '');
                    bubble.textContent = fullResponse;
                    document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
                  }
                } catch (e) {
                  // Ignore parsing errors for incomplete chunks
                }
              }
            }
          }
        } finally {
          reader.releaseLock();
        }
        
        // Add assistant message to history
        chatMessages.push({ role: 'assistant', content: fullResponse });
        
      } catch (error) {
        if (error.name === 'AbortError') {
          updateChatMessage(bubble, 'Response cancelled by user.', false);
        } else {
          console.error('Chat error:', error);
          updateChatMessage(bubble, `Sorry, I encountered an error: ${error.message}`, false);
        }
      } finally {
        // Reset UI state
        currentAbortController = null;
        btnRun.disabled = false;
        sendText.classList.remove('d-none');
        loadingText.classList.add('d-none');
        document.getElementById('btnStopChat').classList.add('d-none');
      }
    });

    // Allow Enter to send message (Shift+Enter for new line)
    document.getElementById('openaiPrompt').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('btnRunOpenAI').click();
      }
    });

    console.log('Tourism Explorer loaded - Maps and chat system initialized!');
  </script>
</body>
</html>